"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const discord_akairo_1 = require("discord-akairo");
const config_1 = require("../../config");
const EmbedUtil_1 = require("../../utils/EmbedUtil");
const partners_1 = require("../../extra/partners");
const discord_js_1 = require("discord.js");
class PingCommand extends discord_akairo_1.Command {
    constructor() {
        super("partners", {
            aliases: ["partners", "affiliates", "affiliate", "partner"],
            category: "Public Commands",
            description: {
                content: "Check out our offiliates who help us out so much!",
                usage: `${config_1.prefix}affiliates`,
                examples: [
                    `${config_1.prefix}affiliates`
                ]
            },
            ratelimit: 3
        });
    }
    async exec(message) {
        if (message.channel.type == "dm")
            return await message.util.send(await EmbedUtil_1.BuildEmbed(this.client, `**Minecraft Genie**`, `*You are not able to run commands in DMs, you must be in a server!*`, [])).then(msg => {
                msg.delete({ timeout: 30000 });
            });
        let pages = partners_1.partners;
        var page = 1;
        const currentPartner = (index) => {
            return pages[page - 1];
        };
        const getInvite = (guild) => {
            return new Promise((resolve, reject) => {
                if (guild.member(this.client.user).permissions.has('VIEW_AUDIT_LOG')) {
                    return guild.fetchInvites().then(invites => {
                        let invite = invites.random();
                        return resolve(`https://www.discord.gg/${invite.code}`);
                    });
                }
                else {
                    return resolve();
                }
            });
        };
        const getEmbed = async (index) => {
            const newEmbed = new discord_js_1.MessageEmbed()
                .setTitle(`**${this.client.guilds.cache.get(currentPartner(page).guild).name}**`)
                .setDescription(`*${currentPartner(page).description}*`)
                .setFooter(`Page ${page}/${pages.length}`)
                .addFields({ name: "Server", value: currentPartner(page).address }, { name: "Discord", value: await getInvite(this.client.guilds.cache.get(currentPartner(page).guild)) ? `[Join Here](${await getInvite(this.client.guilds.cache.get(currentPartner(page).guild))})` : "Unavailable" })
                .setTimestamp()
                .setThumbnail(this.client.guilds.cache.get(currentPartner(page).guild).iconURL())
                .setColor("#1ced9d");
            return newEmbed;
        };
        return message.util.send(await getEmbed(page)).then(msg => {
            msg.react('◀').then(async (r) => {
                msg.react('▶').then(async (r) => {
                    const backwardsFilter = (reaction, user) => reaction.emoji.name === '◀' && user.id === message.author.id;
                    const forwardsFilter = (reaction, user) => reaction.emoji.name === '▶' && user.id === message.author.id;
                    const backwards = msg.createReactionCollector(backwardsFilter, { time: 60000 });
                    const forwards = msg.createReactionCollector(forwardsFilter, { time: 60000 });
                    backwards.on('collect', async (r) => {
                        if (page === 1)
                            return await r.users.remove(message.author);
                        page--;
                        await msg.edit(await getEmbed(page));
                        return await r.users.remove(message.author);
                    });
                    forwards.on('collect', async (r) => {
                        if (page === pages.length)
                            return await r.users.remove(message.author);
                        page++;
                        await msg.edit(await getEmbed(page));
                        return await r.users.remove(message.author);
                    });
                });
            });
        });
    }
}
exports.default = PingCommand;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFydG5lcnNDb21tYW5kcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tYW5kcy9QdWJsaWMgQ29tbWFuZHMvUGFydG5lcnNDb21tYW5kcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1EQUF5QztBQUV6Qyx5Q0FBc0M7QUFDdEMscURBQW1EO0FBQ25ELG1EQUFnRDtBQUNoRCwyQ0FBMEM7QUFJMUMsTUFBcUIsV0FBWSxTQUFRLHdCQUFPO0lBQzVDO1FBQ0ksS0FBSyxDQUFDLFVBQVUsRUFBRTtZQUNkLE9BQU8sRUFBRSxDQUFDLFVBQVUsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLFNBQVMsQ0FBQztZQUMzRCxRQUFRLEVBQUUsaUJBQWlCO1lBQzNCLFdBQVcsRUFBRTtnQkFDVCxPQUFPLEVBQUUsbURBQW1EO2dCQUM1RCxLQUFLLEVBQUUsR0FBRyxlQUFNLFlBQVk7Z0JBQzVCLFFBQVEsRUFBRTtvQkFDTixHQUFHLGVBQU0sWUFBWTtpQkFDeEI7YUFDSjtZQUNELFNBQVMsRUFBRSxDQUFDO1NBQ2YsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBZ0I7UUFDOUIsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxJQUFJO1lBQUUsT0FBTyxNQUFNLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sc0JBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLHFCQUFxQixFQUFFLHFFQUFxRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUN6TSxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUE7WUFDbEMsQ0FBQyxDQUFDLENBQUE7UUFFRixJQUFJLEtBQUssR0FBRyxtQkFBUSxDQUFDO1FBQ3JCLElBQUksSUFBSSxHQUFJLENBQUMsQ0FBQztR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QyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO3dCQUU1QyxJQUFJLEVBQUUsQ0FBQzt3QkFFUCxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzt3QkFFckMsT0FBTyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDcEQsQ0FBQyxDQUFDLENBQUE7Z0JBQ04sQ0FBQyxDQUFDLENBQUE7WUFDTixDQUFDLENBQUMsQ0FBQTtRQUNOLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQztDQUNKO0FBN0ZELDhCQTZGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbW1hbmQgfSBmcm9tIFwiZGlzY29yZC1ha2Fpcm9cIjtcclxuaW1wb3J0IHsgTWVzc2FnZSB9IGZyb20gXCJkaXNjb3JkLmpzXCI7XHJcbmltcG9ydCB7IHByZWZpeCB9IGZyb20gXCIuLi8uLi9jb25maWdcIjtcclxuaW1wb3J0IHsgQnVpbGRFbWJlZCB9IGZyb20gXCIuLi8uLi91dGlscy9FbWJlZFV0aWxcIjtcclxuaW1wb3J0IHsgcGFydG5lcnMgfSBmcm9tIFwiLi4vLi4vZXh0cmEvcGFydG5lcnNcIjtcclxuaW1wb3J0IHsgTWVzc2FnZUVtYmVkIH0gZnJvbSBcImRpc2NvcmQuanNcIjtcclxuaW1wb3J0IHsgR3VpbGQgfSBmcm9tIFwiZGlzY29yZC5qc1wiO1xyXG5pbXBvcnQgeyBJbnZpdGUgfSBmcm9tIFwiZGlzY29yZC5qc1wiO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGluZ0NvbW1hbmQgZXh0ZW5kcyBDb21tYW5kIHtcclxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBzdXBlcihcInBhcnRuZXJzXCIsIHtcclxuICAgICAgICAgICAgYWxpYXNlczogW1wicGFydG5lcnNcIiwgXCJhZmZpbGlhdGVzXCIsIFwiYWZmaWxpYXRlXCIsIFwicGFydG5lclwiXSxcclxuICAgICAgICAgICAgY2F0ZWdvcnk6IFwiUHVibGljIENvbW1hbmRzXCIsXHJcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiB7XHJcbiAgICAgICAgICAgICAgICBjb250ZW50OiBcIkNoZWNrIG91dCBvdXIgb2ZmaWxpYXRlcyB3aG8gaGVscCB1cyBvdXQgc28gbXVjaCFcIixcclxuICAgICAgICAgICAgICAgIHVzYWdlOiBgJHtwcmVmaXh9YWZmaWxpYXRlc2AsXHJcbiAgICAgICAgICAgICAgICBleGFtcGxlczogW1xyXG4gICAgICAgICAgICAgICAgICAgIGAke3ByZWZpeH1hZmZpbGlhdGVzYFxyXG4gICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByYXRlbGltaXQ6IDNcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgZXhlYyhtZXNzYWdlOiBNZXNzYWdlKTogUHJvbWlzZTxhbnk+IHtcclxuICAgICAgICBpZiAobWVzc2FnZS5jaGFubmVsLnR5cGUgPT0gXCJkbVwiKSByZXR1cm4gYXdhaXQgbWVzc2FnZS51dGlsLnNlbmQoYXdhaXQgQnVpbGRFbWJlZCh0aGlzLmNsaWVudCwgYCoqTWluZWNyYWZ0IEdlbmllKipgLCBgKllvdSBhcmUgbm90IGFibGUgdG8gcnVuIGNvbW1hbmRzIGluIERNcywgeW91IG11c3QgYmUgaW4gYSBzZXJ2ZXIhKmAsIFtdKSkudGhlbihtc2cgPT4ge1xyXG4gICAgICAgICAgICBtc2cuZGVsZXRlKHsgdGltZW91dDogMzAwMDAgfSlcclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICBsZXQgcGFnZXMgPSBwYXJ0bmVycztcclxuICAgICAgICB2YXIgcGFnZSAgPSAxO1xyXG5cclxuICAgICAgICBjb25zdCBjdXJyZW50UGFydG5lciA9IChpbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBwYWdlc1twYWdlIC0gMV07XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgY29uc3QgZ2V0SW52aXRlID0gKGd1aWxkOiBHdWlsZCk6IFByb21pc2U8c3RyaW5nPiA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZ3VpbGQubWVtYmVyKHRoaXMuY2xpZW50LnVzZXIpLnBlcm1pc3Npb25zLmhhcygnVklFV19BVURJVF9MT0cnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBndWlsZC5mZXRjaEludml0ZXMoKS50aGVuKGludml0ZXMgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgaW52aXRlOiBJbnZpdGUgPSBpbnZpdGVzLnJhbmRvbSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShgaHR0cHM6Ly93d3cuZGlzY29yZC5nZy8ke2ludml0ZS5jb2RlfWApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG5cclxuICAgICAgICBjb25zdCBnZXRFbWJlZCA9IGFzeW5jIChpbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5ld0VtYmVkID0gbmV3IE1lc3NhZ2VFbWJlZCgpXHJcbiAgICAgICAgICAgICAgICAuc2V0VGl0bGUoYCoqJHt0aGlzLmNsaWVudC5ndWlsZHMuY2FjaGUuZ2V0KGN1cnJlbnRQYXJ0bmVyKHBhZ2UpLmd1aWxkKS5uYW1lfSoqYClcclxuICAgICAgICAgICAgICAgIC5zZXREZXNjcmlwdGlvbihgKiR7Y3VycmVudFBhcnRuZXIocGFnZSkuZGVzY3JpcHRpb259KmApXHJcbiAgICAgICAgICAgICAgICAuc2V0Rm9vdGVyKGBQYWdlICR7cGFnZX0vJHtwYWdlcy5sZW5ndGh9YClcclxuICAgICAgICAgICAgICAgIC5hZGRGaWVsZHMoXHJcbiAgICAgICAgICAgICAgICAgICAgeyBuYW1lOiBcIlNlcnZlclwiLCB2YWx1ZTogY3VycmVudFBhcnRuZXIocGFnZSkuYWRkcmVzcyB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHsgbmFtZTogXCJEaXNjb3JkXCIsIHZhbHVlOiBhd2FpdCBnZXRJbnZpdGUodGhpcy5jbGllbnQuZ3VpbGRzLmNhY2hlLmdldChjdXJyZW50UGFydG5lcihwYWdlKS5ndWlsZCkpID8gYFtKb2luIEhlcmVdKCR7YXdhaXQgZ2V0SW52aXRlKHRoaXMuY2xpZW50Lmd1aWxkcy5jYWNoZS5nZXQoY3VycmVudFBhcnRuZXIocGFnZSkuZ3VpbGQpKX0pYCA6IFwiVW5hdmFpbGFibGVcIiB9XHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICAgICAuc2V0VGltZXN0YW1wKClcclxuICAgICAgICAgICAgICAgIC5zZXRUaHVtYm5haWwodGhpcy5jbGllbnQuZ3VpbGRzLmNhY2hlLmdldChjdXJyZW50UGFydG5lcihwYWdlKS5ndWlsZCkuaWNvblVSTCgpKVxyXG4gICAgICAgICAgICAgICAgLnNldENvbG9yKFwiIzFjZWQ5ZFwiKVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIG5ld0VtYmVkO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG1lc3NhZ2UudXRpbC5zZW5kKGF3YWl0IGdldEVtYmVkKHBhZ2UpKS50aGVuKG1zZyA9PiB7XHJcbiAgICAgICAgICAgIG1zZy5yZWFjdCgn4peAJykudGhlbihhc3luYyByID0+IHtcclxuICAgICAgICAgICAgICAgIG1zZy5yZWFjdCgn4pa2JykudGhlbihhc3luYyByID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBiYWNrd2FyZHNGaWx0ZXIgPSAocmVhY3Rpb24sIHVzZXIpID0+IHJlYWN0aW9uLmVtb2ppLm5hbWUgPT09ICfil4AnICYmIHVzZXIuaWQgPT09IG1lc3NhZ2UuYXV0aG9yLmlkO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcndhcmRzRmlsdGVyID0gKHJlYWN0aW9uLCB1c2VyKSA9PiByZWFjdGlvbi5lbW9qaS5uYW1lID09PSAn4pa2JyAmJiB1c2VyLmlkID09PSBtZXNzYWdlLmF1dGhvci5pZDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFja3dhcmRzID0gbXNnLmNyZWF0ZVJlYWN0aW9uQ29sbGVjdG9yKGJhY2t3YXJkc0ZpbHRlciwgeyB0aW1lOiA2MDAwMCB9KTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3J3YXJkcyA9IG1zZy5jcmVhdGVSZWFjdGlvbkNvbGxlY3Rvcihmb3J3YXJkc0ZpbHRlciwgeyB0aW1lOiA2MDAwMCB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgYmFja3dhcmRzLm9uKCdjb2xsZWN0JywgYXN5bmMgciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYWdlID09PSAxKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHIudXNlcnMucmVtb3ZlKG1lc3NhZ2UuYXV0aG9yKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlLS07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgbXNnLmVkaXQoYXdhaXQgZ2V0RW1iZWQocGFnZSkpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCByLnVzZXJzLnJlbW92ZShtZXNzYWdlLmF1dGhvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZm9yd2FyZHMub24oJ2NvbGxlY3QnLCBhc3luYyByID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2UgPT09IHBhZ2VzLmxlbmd0aClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCByLnVzZXJzLnJlbW92ZShtZXNzYWdlLmF1dGhvcik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZSsrO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IG1zZy5lZGl0KGF3YWl0IGdldEVtYmVkKHBhZ2UpKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgci51c2Vycy5yZW1vdmUobWVzc2FnZS5hdXRob3IpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcbn1cclxuIl19