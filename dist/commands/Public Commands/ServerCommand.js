"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const discord_akairo_1 = require("discord-akairo");
const config_1 = require("../../config");
const EmbedUtil_1 = require("../../utils/EmbedUtil");
const dns_1 = __importDefault(require("dns"));
const discord_js_1 = require("discord.js");
const fs_1 = __importDefault(require("fs"));
const axios_1 = __importDefault(require("axios"));
class InfoCommand extends discord_akairo_1.Command {
    constructor() {
        super("server", {
            aliases: ["server", "servers", "players", "ip", "servercount", "serv", "rcon"],
            category: "Public Commands",
            description: {
                content: "View server information with the bot, by supplying both a IP and port!",
                usage: `${config_1.prefix}server [ip/domain] -port=[port]`,
                examples: [
                    `${config_1.prefix}server hypixel.net -port=25565`,
                    `${config_1.prefix}server 172.65.212.227 -port=25565`
                ]
            },
            ratelimit: 3,
            args: [
                {
                    id: "host",
                    type: (_, str) => {
                        if (str.toLowerCase() === "help")
                            return "SHOW_INFORMATION_SECTION";
                        if (isIPv4(str))
                            return str;
                        if (isDomain(str))
                            return str;
                        return null;
                    },
                    match: "phrase",
                    default: "172.65.212.227"
                },
                {
                    id: "port",
                    type: (_, str) => {
                        if (str && !isNaN(Number(str)) && isPort(Number(str)))
                            return Number(str);
                        return null;
                    },
                    match: "option",
                    flag: ["-port="],
                    default: 25565
                }
            ]
        });
    }
    async exec(message, { host, port }) {
        if (message.channel.type == "dm")
            return await message.util.send(await EmbedUtil_1.BuildEmbed(this.client, `**Minecraft Genie**`, `*You are not able to run commands in DMs, you must be in a server!*`, [])).then(msg => {
                msg.delete({ timeout: 30000 });
            });
        if (host === "SHOW_INFORMATION_SECTION")
            return await message.util.send(await EmbedUtil_1.BuildEmbed(this.client, "**Minecraft Genie**", "*You must provide a Username or UUID!*", [
                { name: `Usage`, value: `${this.description["usage"]}` },
                { name: `Examples`, value: `${this.description["examples"].join("\n")}` }
            ])).then(msg => {
                msg.delete({ timeout: 60000 });
            });
        return await message.util.send(await EmbedUtil_1.BuildEmbed(this.client, `**Minecraft Genie**`, `*Attempting to retrieving information...*`, [
            { name: `Host`, value: host, inline: true },
            { name: `Port`, value: port.toString(), inline: true }
        ])).then(async (msg) => {
            let serverInformation = await jsonRequest(`${host}:${port}`).catch(async (error) => {
                return await msg.edit(await EmbedUtil_1.BuildEmbed(this.client, `**Minecraft Genie**`, `*We had trouble retrieving information on: \`${host}:${port}\`*`, [])).then(async (msg) => {
                    msg.delete({ timeout: 30000 });
                });
            });
            if (!serverInformation["online"]) {
                return await msg.edit(await EmbedUtil_1.BuildEmbed(this.client, `**Minecraft Genie**`, `*We had trouble contacting host: \`${host}:${port}\` so we're going to check for other ports!*`, [])).then(async (msg) => {
                    let seekingPortInformation = await jsonRequest(`${host}`).catch(async (error) => {
                        return await msg.edit(await EmbedUtil_1.BuildEmbed(this.client, `**Minecraft Genie**`, `*We were unable to find any Minecraft Server ports for: \`${host}\`*`, [])).then(async (msg) => {
                            msg.delete({ timeout: 30000 });
                        });
                    });
                    if (!seekingPortInformation["online"]) {
                        return await msg.edit(await EmbedUtil_1.BuildEmbed(this.client, `**Minecraft Genie**`, `*We were unable to find any Minecraft Server ports for: \`${host}\`*`, [])).then(async (msg) => {
                            msg.delete({ timeout: 30000 });
                        });
                    }
                    else {
                        return sendMessage(seekingPortInformation);
                    }
                });
            }
            else {
                return sendMessage(serverInformation);
            }
            async function sendMessage(result) {
                let serverStatus = {
                    host: result["ip"],
                    port: result["port"],
                    players: {
                        max: result["players"]["max"],
                        online: result["players"]["online"]
                    },
                    version: {
                        name: result["version"],
                        protocol: result["protocol"]
                    },
                    online: result["online"],
                    favicon: result["icon"],
                    hostname: result["hostname"],
                    description: result["motd"]["clean"]
                };
                var bitmap = Buffer.from(serverStatus.favicon.split('data:image/png;base64,').pop(), 'base64');
                fs_1.default.writeFileSync(`${__dirname}/../../favicons/${serverStatus.host}.png`, bitmap);
                let updatedEmbed = new discord_js_1.MessageEmbed()
                    .setTitle(`**Minecraft Genie**`)
                    .setDescription(`*Successfully retrieved server information for: \`${serverStatus.host}:${serverStatus.port}\`*`)
                    .attachFiles([`${__dirname}/../../favicons/${serverStatus.host}.png`])
                    .setThumbnail(`attachment://${serverStatus.host}.png`)
                    .setFooter('Reheight#4947')
                    .setTimestamp()
                    .addFields({ name: "Player Count", value: `\`${serverStatus.players.online}/${serverStatus.players.max}\`` }, { name: "Description", value: `\`${serverStatus.description.join("\n")}\`` }, { name: "Version", value: `\`${serverStatus.version.name}\`` }, { name: "Version Protocol", value: `\`${serverStatus.version.protocol}\`` }, { name: "Address", value: `\`${serverStatus.host}\`` }, { name: "Hostname", value: `\`${serverStatus.hostname}\`` }, { name: "Port", value: `\`${serverStatus.port}\`` }, { name: "Status", value: `\`${serverStatus.online ? "Online" : "Offline"}\`` })
                    .setColor("#1ced9d");
                await msg.delete();
                return await message.util.send(updatedEmbed).then(async (msg) => {
                    await msg.delete({ timeout: 120000 });
                });
            }
        });
    }
}
exports.default = InfoCommand;
const isIPv4 = (address) => {
    let regex = /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    return regex.test(address);
};
const isDomain = (address) => {
    let regex = /[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})+/;
    return regex.test(address);
};
const isPort = (port) => {
    let regex = /^([0-9]{1,4}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$/;
    return regex.test(port.toString());
};
const IPv4 = (address) => {
    return new Promise((resolve, reject) => {
        dns_1.default.lookup(address, (err, result) => {
            console.log(address);
            if (err)
                reject(err);
            resolve(result);
        });
    });
};
var jsonRequest = (address) => {
    return new Promise((resolve, reject) => {
        axios_1.default.get(`https://api.mcsrvstat.us/2/${address}`).then((response) => {
            resolve(response["data"]);
        }).catch((error) => {
            reject(error);
        });
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VydmVyQ29tbWFuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tYW5kcy9QdWJsaWMgQ29tbWFuZHMvU2VydmVyQ29tbWFuZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLG1EQUF5QztBQUV6Qyx5Q0FBc0M7QUFDdEMscURBQW1EO0FBRW5ELDhDQUFzQjtBQUN0QiwyQ0FBMEM7QUFDMUMsNENBQW9CO0FBQ3BCLGtEQUEwQjtBQUUxQixNQUFxQixXQUFZLFNBQVEsd0JBQU87SUFDNUM7UUFDSSxLQUFLLENBQUMsUUFBUSxFQUFFO1lBQ1osT0FBTyxFQUFFLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQzlFLFFBQVEsRUFBRSxpQkFBaUI7WUFDM0IsV0FBVyxFQUFFO2dCQUNULE9BQU8sRUFBRSx3RUFBd0U7Z0JBQ2pGLEtBQUssRUFBRSxHQUFHLGVBQU0saUNBQWlDO2dCQUNqRCxRQUFRLEVBQUU7b0JBQ04sR0FBRyxlQUFNLGdDQUFnQztvQkFDekMsR0FBRyxlQUFNLG1DQUFtQztpQkFDL0M7YUFDSjtZQUNELFNBQVMsRUFBRSxDQUFDO1lBQ1osSUFBSSxFQUFFO2dCQUNGO29CQUNJLEVBQUUsRUFBRSxNQUFNO29CQUNWLElBQUksRUFBRSxDQUFDLENBQVUsRUFBRSxHQUFXLEVBQWlCLEVBQUU7d0JBQzdDLElBQUksR0FBRyxDQUFDLFdBQVcsRUFBRSxLQUFLLE1BQU07NEJBQUUsT0FBTywwQkFBMEIsQ0FBQzt3QkFFcEUsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDOzRCQUFFLE9BQU8sR0FBRyxDQUFDO3dCQUU1QixJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUM7NEJBQUUsT0FBTyxHQUFHLENBQUM7d0JBRTlCLE9BQU8sSUFBSSxDQUFDO29CQUNoQixDQUFDO29CQUNELEtBQUssRUFBRSxRQUFRO29C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SUFDN0IsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUNuQyxhQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNoQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3JCLElBQUksR0FBRztnQkFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDckIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3BCLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQyxDQUFDLENBQUE7QUFDTixDQUFDLENBQUE7QUFFRCxJQUFJLFdBQVcsR0FBRyxDQUFDLE9BQU8sRUFBZ0IsRUFBRTtJQUN4QyxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQ25DLGVBQUssQ0FBQyxHQUFHLENBQUMsOEJBQThCLE9BQU8sRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDakUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQzlCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQ2YsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xCLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQyxDQUFDLENBQUE7QUFDTixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21tYW5kIH0gZnJvbSBcImRpc2NvcmQtYWthaXJvXCI7XHJcbmltcG9ydCB7IE1lc3NhZ2UgfSBmcm9tIFwiZGlzY29yZC5qc1wiO1xyXG5pbXBvcnQgeyBwcmVmaXggfSBmcm9tIFwiLi4vLi4vY29uZmlnXCI7XHJcbmltcG9ydCB7IEJ1aWxkRW1iZWQgfSBmcm9tIFwiLi4vLi4vdXRpbHMvRW1iZWRVdGlsXCI7XHJcbmltcG9ydCBNQ1AgZnJvbSBcIm1pbmVjcmFmdC1wcm90b2NvbFwiO1xyXG5pbXBvcnQgRE5TIGZyb20gXCJkbnNcIjtcclxuaW1wb3J0IHsgTWVzc2FnZUVtYmVkIH0gZnJvbSBcImRpc2NvcmQuanNcIjtcclxuaW1wb3J0IGZzIGZyb20gXCJmc1wiO1xyXG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSW5mb0NvbW1hbmQgZXh0ZW5kcyBDb21tYW5kIHtcclxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBzdXBlcihcInNlcnZlclwiLCB7XHJcbiAgICAgICAgICAgIGFsaWFzZXM6IFtcInNlcnZlclwiLCBcInNlcnZlcnNcIiwgXCJwbGF5ZXJzXCIsIFwiaXBcIiwgXCJzZXJ2ZXJjb3VudFwiLCBcInNlcnZcIiwgXCJyY29uXCJdLFxyXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJQdWJsaWMgQ29tbWFuZHNcIixcclxuICAgICAgICAgICAgZGVzY3JpcHRpb246IHtcclxuICAgICAgICAgICAgICAgIGNvbnRlbnQ6IFwiVmlldyBzZXJ2ZXIgaW5mb3JtYXRpb24gd2l0aCB0aGUgYm90LCBieSBzdXBwbHlpbmcgYm90aCBhIElQIGFuZCBwb3J0IVwiLFxyXG4gICAgICAgICAgICAgICAgdXNhZ2U6IGAke3ByZWZpeH1zZXJ2ZXIgW2lwL2RvbWFpbl0gLXBvcnQ9W3BvcnRdYCxcclxuICAgICAgICAgICAgICAgIGV4YW1wbGVzOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgYCR7cHJlZml4fXNlcnZlciBoeXBpeGVsLm5ldCAtcG9ydD0yNTU2NWAsXHJcbiAgICAgICAgICAgICAgICAgICAgYCR7cHJlZml4fXNlcnZlciAxNzIuNjUuMjEyLjIyNyAtcG9ydD0yNTU2NWBcclxuICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcmF0ZWxpbWl0OiAzLFxyXG4gICAgICAgICAgICBhcmdzOiBbXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWQ6IFwiaG9zdFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IChfOiBNZXNzYWdlLCBzdHI6IHN0cmluZyk6IG51bGwgfCBzdHJpbmcgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RyLnRvTG93ZXJDYXNlKCkgPT09IFwiaGVscFwiKSByZXR1cm4gXCJTSE9XX0lORk9STUFUSU9OX1NFQ1RJT05cIjtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0lQdjQoc3RyKSkgcmV0dXJuIHN0cjtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0RvbWFpbihzdHIpKSByZXR1cm4gc3RyO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBtYXRjaDogXCJwaHJhc2VcIixcclxuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OiBcIjE3Mi42NS4yMTIuMjI3XCJcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWQ6IFwicG9ydFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IChfOiBNZXNzYWdlLCBzdHI6IHN0cmluZyk6IG51bGwgfCBOdW1iZXIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RyICYmICFpc05hTihOdW1iZXIoc3RyKSkgJiYgaXNQb3J0KE51bWJlcihzdHIpKSkgcmV0dXJuIE51bWJlcihzdHIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIG1hdGNoOiBcIm9wdGlvblwiLFxyXG4gICAgICAgICAgICAgICAgICAgIGZsYWc6IFtcIi1wb3J0PVwiXSxcclxuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OiAyNTU2NVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBdXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIGV4ZWMobWVzc2FnZTogTWVzc2FnZSwgeyBob3N0LCBwb3J0IH06IHsgaG9zdDogc3RyaW5nLCBwb3J0OiBudW1iZXIgfSk6IFByb21pc2U8YW55PiB7XHJcbiAgICAgICAgaWYgKG1lc3NhZ2UuY2hhbm5lbC50eXBlID09IFwiZG1cIikgcmV0dXJuIGF3YWl0IG1lc3NhZ2UudXRpbC5zZW5kKGF3YWl0IEJ1aWxkRW1iZWQodGhpcy5jbGllbnQsIGAqKk1pbmVjcmFmdCBHZW5pZSoqYCwgYCpZb3UgYXJlIG5vdCBhYmxlIHRvIHJ1biBjb21tYW5kcyBpbiBETXMsIHlvdSBtdXN0IGJlIGluIGEgc2VydmVyISpgLCBbXSkpLnRoZW4obXNnID0+IHtcclxuICAgICAgICAgICAgbXNnLmRlbGV0ZSh7IHRpbWVvdXQ6IDMwMDAwIH0pXHJcbiAgICAgICAgfSlcclxuICAgICAgICBcclxuICAgICAgICBpZiAoaG9zdCA9PT0gXCJTSE9XX0lORk9STUFUSU9OX1NFQ1RJT05cIikgcmV0dXJuIGF3YWl0IG1lc3NhZ2UudXRpbC5zZW5kKGF3YWl0IEJ1aWxkRW1iZWQodGhpcy5jbGllbnQsIFwiKipNaW5lY3JhZnQgR2VuaWUqKlwiLCBcIipZb3UgbXVzdCBwcm92aWRlIGEgVXNlcm5hbWUgb3IgVVVJRCEqXCIsIFtcclxuICAgICAgICAgICAgeyBuYW1lOiBgVXNhZ2VgLCB2YWx1ZTogYCR7dGhpcy5kZXNjcmlwdGlvbltcInVzYWdlXCJdfWAgfSxcclxuICAgICAgICAgICAgeyBuYW1lOiBgRXhhbXBsZXNgLCB2YWx1ZTogYCR7dGhpcy5kZXNjcmlwdGlvbltcImV4YW1wbGVzXCJdLmpvaW4oXCJcXG5cIil9YCB9XHJcbiAgICAgICAgXSkpLnRoZW4obXNnID0+IHtcclxuICAgICAgICAgICAgbXNnLmRlbGV0ZSh7IHRpbWVvdXQ6IDYwMDAwIH0pXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IG1lc3NhZ2UudXRpbC5zZW5kKGF3YWl0IEJ1aWxkRW1iZWQodGhpcy5jbGllbnQsIGAqKk1pbmVjcmFmdCBHZW5pZSoqYCwgYCpBdHRlbXB0aW5nIHRvIHJldHJpZXZpbmcgaW5mb3JtYXRpb24uLi4qYCwgW1xyXG4gICAgICAgICAgICB7IG5hbWU6IGBIb3N0YCwgdmFsdWU6IGhvc3QsIGlubGluZTogdHJ1ZSB9LFxyXG4gICAgICAgICAgICB7IG5hbWU6IGBQb3J0YCwgdmFsdWU6IHBvcnQudG9TdHJpbmcoKSwgaW5saW5lOiB0cnVlIH1cclxuICAgICAgICBdKSkudGhlbihhc3luYyAobXNnKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBzZXJ2ZXJJbmZvcm1hdGlvbiA9IGF3YWl0IGpzb25SZXF1ZXN0KGAke2hvc3R9OiR7cG9ydH1gKS5jYXRjaChhc3luYyAoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBtc2cuZWRpdChhd2FpdCBCdWlsZEVtYmVkKHRoaXMuY2xpZW50LCBgKipNaW5lY3JhZnQgR2VuaWUqKmAsIGAqV2UgaGFkIHRyb3VibGUgcmV0cmlldmluZyBpbmZvcm1hdGlvbiBvbjogXFxgJHtob3N0fToke3BvcnR9XFxgKmAsIFtdKSkudGhlbihhc3luYyAobXNnKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbXNnLmRlbGV0ZSh7IHRpbWVvdXQ6IDMwMDAwIH0pO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgICAgIGlmICghc2VydmVySW5mb3JtYXRpb25bXCJvbmxpbmVcIl0pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBtc2cuZWRpdChhd2FpdCBCdWlsZEVtYmVkKHRoaXMuY2xpZW50LCBgKipNaW5lY3JhZnQgR2VuaWUqKmAsIGAqV2UgaGFkIHRyb3VibGUgY29udGFjdGluZyBob3N0OiBcXGAke2hvc3R9OiR7cG9ydH1cXGAgc28gd2UncmUgZ29pbmcgdG8gY2hlY2sgZm9yIG90aGVyIHBvcnRzISpgLCBbXSkpLnRoZW4oYXN5bmMgKG1zZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzZWVraW5nUG9ydEluZm9ybWF0aW9uID0gYXdhaXQganNvblJlcXVlc3QoYCR7aG9zdH1gKS5jYXRjaChhc3luYyAoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IG1zZy5lZGl0KGF3YWl0IEJ1aWxkRW1iZWQodGhpcy5jbGllbnQsIGAqKk1pbmVjcmFmdCBHZW5pZSoqYCwgYCpXZSB3ZXJlIHVuYWJsZSB0byBmaW5kIGFueSBNaW5lY3JhZnQgU2VydmVyIHBvcnRzIGZvcjogXFxgJHtob3N0fVxcYCpgLCBbXSkpLnRoZW4oYXN5bmMgKG1zZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnLmRlbGV0ZSh7IHRpbWVvdXQ6IDMwMDAwIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghc2Vla2luZ1BvcnRJbmZvcm1hdGlvbltcIm9ubGluZVwiXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgbXNnLmVkaXQoYXdhaXQgQnVpbGRFbWJlZCh0aGlzLmNsaWVudCwgYCoqTWluZWNyYWZ0IEdlbmllKipgLCBgKldlIHdlcmUgdW5hYmxlIHRvIGZpbmQgYW55IE1pbmVjcmFmdCBTZXJ2ZXIgcG9ydHMgZm9yOiBcXGAke2hvc3R9XFxgKmAsIFtdKSkudGhlbihhc3luYyAobXNnKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2cuZGVsZXRlKHsgdGltZW91dDogMzAwMDAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbmRNZXNzYWdlKHNlZWtpbmdQb3J0SW5mb3JtYXRpb24pXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBzZW5kTWVzc2FnZShzZXJ2ZXJJbmZvcm1hdGlvbik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGFzeW5jIGZ1bmN0aW9uIHNlbmRNZXNzYWdlKHJlc3VsdDogb2JqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICBpbnRlcmZhY2Ugc2VydmVySW5mb3JtYXRpb24ge1xyXG4gICAgICAgICAgICAgICAgICAgIGhvc3Q6IHN0cmluZyxcclxuICAgICAgICAgICAgICAgICAgICBwb3J0OiBudW1iZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgcGxheWVyczoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXg6IG51bWJlcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgb25saW5lOiBudW1iZXJcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHZlcnNpb246IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogc3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm90b2NvbDogbnVtYmVyXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBvbmxpbmU6IGJvb2xlYW4sXHJcbiAgICAgICAgICAgICAgICAgICAgZmF2aWNvbjogc3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgIGhvc3RuYW1lOiBzdHJpbmcsXHJcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHN0cmluZ1tdXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHNlcnZlclN0YXR1czogc2VydmVySW5mb3JtYXRpb24gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaG9zdDogcmVzdWx0W1wiaXBcIl0sXHJcbiAgICAgICAgICAgICAgICAgICAgcG9ydDogcmVzdWx0W1wicG9ydFwiXSxcclxuICAgICAgICAgICAgICAgICAgICBwbGF5ZXJzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1heDogcmVzdWx0W1wicGxheWVyc1wiXVtcIm1heFwiXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgb25saW5lOiByZXN1bHRbXCJwbGF5ZXJzXCJdW1wib25saW5lXCJdXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHJlc3VsdFtcInZlcnNpb25cIl0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RvY29sOiByZXN1bHRbXCJwcm90b2NvbFwiXVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgb25saW5lOiByZXN1bHRbXCJvbmxpbmVcIl0sXHJcbiAgICAgICAgICAgICAgICAgICAgZmF2aWNvbjogcmVzdWx0W1wiaWNvblwiXSxcclxuICAgICAgICAgICAgICAgICAgICBob3N0bmFtZTogcmVzdWx0W1wiaG9zdG5hbWVcIl0sXHJcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHJlc3VsdFtcIm1vdGRcIl1bXCJjbGVhblwiXVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHZhciBiaXRtYXAgPSBCdWZmZXIuZnJvbShzZXJ2ZXJTdGF0dXMuZmF2aWNvbi5zcGxpdCgnZGF0YTppbWFnZS9wbmc7YmFzZTY0LCcpLnBvcCgpLCAnYmFzZTY0Jyk7XHJcblxyXG4gICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhgJHtfX2Rpcm5hbWV9Ly4uLy4uL2Zhdmljb25zLyR7c2VydmVyU3RhdHVzLmhvc3R9LnBuZ2AsIGJpdG1hcCk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHVwZGF0ZWRFbWJlZDogTWVzc2FnZUVtYmVkID0gbmV3IE1lc3NhZ2VFbWJlZCgpXHJcbiAgICAgICAgICAgICAgICAuc2V0VGl0bGUoYCoqTWluZWNyYWZ0IEdlbmllKipgKVxyXG4gICAgICAgICAgICAgICAgLnNldERlc2NyaXB0aW9uKGAqU3VjY2Vzc2Z1bGx5IHJldHJpZXZlZCBzZXJ2ZXIgaW5mb3JtYXRpb24gZm9yOiBcXGAke3NlcnZlclN0YXR1cy5ob3N0fToke3NlcnZlclN0YXR1cy5wb3J0fVxcYCpgKVxyXG4gICAgICAgICAgICAgICAgLmF0dGFjaEZpbGVzKFtgJHtfX2Rpcm5hbWV9Ly4uLy4uL2Zhdmljb25zLyR7c2VydmVyU3RhdHVzLmhvc3R9LnBuZ2BdKVxyXG4gICAgICAgICAgICAgICAgLnNldFRodW1ibmFpbChgYXR0YWNobWVudDovLyR7c2VydmVyU3RhdHVzLmhvc3R9LnBuZ2ApXHJcbiAgICAgICAgICAgICAgICAuc2V0Rm9vdGVyKCdSZWhlaWdodCM0OTQ3JylcclxuICAgICAgICAgICAgICAgIC5zZXRUaW1lc3RhbXAoKVxyXG4gICAgICAgICAgICAgICAgLmFkZEZpZWxkcyhcclxuICAgICAgICAgICAgICAgICAgICB7IG5hbWU6IFwiUGxheWVyIENvdW50XCIsIHZhbHVlOiBgXFxgJHtzZXJ2ZXJTdGF0dXMucGxheWVycy5vbmxpbmV9LyR7c2VydmVyU3RhdHVzLnBsYXllcnMubWF4fVxcYGAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7IG5hbWU6IFwiRGVzY3JpcHRpb25cIiwgdmFsdWU6IGBcXGAke3NlcnZlclN0YXR1cy5kZXNjcmlwdGlvbi5qb2luKFwiXFxuXCIpfVxcYGAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7IG5hbWU6IFwiVmVyc2lvblwiLCB2YWx1ZTogYFxcYCR7c2VydmVyU3RhdHVzLnZlcnNpb24ubmFtZX1cXGBgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgeyBuYW1lOiBcIlZlcnNpb24gUHJvdG9jb2xcIiwgdmFsdWU6IGBcXGAke3NlcnZlclN0YXR1cy52ZXJzaW9uLnByb3RvY29sfVxcYGAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7IG5hbWU6IFwiQWRkcmVzc1wiLCB2YWx1ZTogYFxcYCR7c2VydmVyU3RhdHVzLmhvc3R9XFxgYCB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHsgbmFtZTogXCJIb3N0bmFtZVwiLCB2YWx1ZTogYFxcYCR7c2VydmVyU3RhdHVzLmhvc3RuYW1lfVxcYGAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7IG5hbWU6IFwiUG9ydFwiLCB2YWx1ZTogYFxcYCR7c2VydmVyU3RhdHVzLnBvcnR9XFxgYCB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHsgbmFtZTogXCJTdGF0dXNcIiwgdmFsdWU6IGBcXGAke3NlcnZlclN0YXR1cy5vbmxpbmUgPyBcIk9ubGluZVwiIDogXCJPZmZsaW5lXCJ9XFxgYCB9LFxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICAgLnNldENvbG9yKFwiIzFjZWQ5ZFwiKVxyXG5cclxuICAgICAgICAgICAgICAgIGF3YWl0IG1zZy5kZWxldGUoKTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgbWVzc2FnZS51dGlsLnNlbmQodXBkYXRlZEVtYmVkKS50aGVuKGFzeW5jIChtc2cpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBtc2cuZGVsZXRlKHsgdGltZW91dDogMTIwMDAwIH0pO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcbn1cclxuXHJcblxyXG5jb25zdCBpc0lQdjQgPSAoYWRkcmVzczogc3RyaW5nKTogYm9vbGVhbiA9PiB7XHJcbiAgICBsZXQgcmVnZXggPSAvXigoMjVbMC01XXwyWzAtNF1bMC05XXxbMDFdP1swLTldWzAtOV0/KVxcLil7M30oMjVbMC01XXwyWzAtNF1bMC05XXxbMDFdP1swLTldWzAtOV0/KSQvO1xyXG4gICAgcmV0dXJuIHJlZ2V4LnRlc3QoYWRkcmVzcyk7XHJcbn1cclxuXHJcbmNvbnN0IGlzRG9tYWluID0gKGFkZHJlc3M6IHN0cmluZyk6IGJvb2xlYW4gPT4ge1xyXG4gICAgbGV0IHJlZ2V4ID0gL1thLXpBLVowLTldW2EtekEtWjAtOS1dezEsNjF9W2EtekEtWjAtOV0oPzpcXC5bYS16QS1aXXsyLH0pKy87XHJcbiAgICByZXR1cm4gcmVnZXgudGVzdChhZGRyZXNzKTtcclxufVxyXG5cclxuY29uc3QgaXNQb3J0ID0gKHBvcnQ6IG51bWJlcik6IGJvb2xlYW4gPT4ge1xyXG4gICAgbGV0IHJlZ2V4ID0gL14oWzAtOV17MSw0fXxbMS01XVswLTldezR9fDZbMC00XVswLTldezN9fDY1WzAtNF1bMC05XXsyfXw2NTVbMC0yXVswLTldfDY1NTNbMC01XSkkLztcclxuICAgIHJldHVybiByZWdleC50ZXN0KHBvcnQudG9TdHJpbmcoKSk7XHJcbn1cclxuXHJcbmNvbnN0IElQdjQgPSAoYWRkcmVzczogc3RyaW5nKSA9PiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgIEROUy5sb29rdXAoYWRkcmVzcywgKGVyciwgcmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGFkZHJlc3MpO1xyXG4gICAgICAgICAgICBpZiAoZXJyKSByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICAgIH0pXHJcbiAgICB9KVxyXG59XHJcblxyXG52YXIganNvblJlcXVlc3QgPSAoYWRkcmVzcyk6IFByb21pc2U8YW55PiA9PiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgIGF4aW9zLmdldChgaHR0cHM6Ly9hcGkubWNzcnZzdGF0LnVzLzIvJHthZGRyZXNzfWApLnRoZW4oKHJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2VbXCJkYXRhXCJdKTtcclxuICAgICAgICB9KS5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICB9KVxyXG4gICAgfSlcclxufSJdfQ==