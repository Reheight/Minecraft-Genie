"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const discord_akairo_1 = require("discord-akairo");
const config_1 = require("../../config");
const EmbedUtil_1 = require("../../utils/EmbedUtil");
const minecraft_player_1 = __importDefault(require("minecraft-player"));
const fs_1 = __importDefault(require("fs"));
const request_1 = __importDefault(require("request"));
class ModelCommand extends discord_akairo_1.Command {
    constructor() {
        super("model", {
            aliases: ["model", "skin", "player", "render", "view"],
            category: "Public Commands",
            description: {
                content: "View the rendered skin of a registered Minecraft member.",
                usage: `${config_1.prefix}model [username/uuid]`,
                examples: [
                    `${config_1.prefix}model Reheight`,
                    `${config_1.prefix}model d4be07ab-fc80-46ca-8706-70947a8e9beb`
                ]
            },
            ratelimit: 3
        });
    }
    async exec(message, { identifier }) {
        if (message.channel.type == "dm")
            return await message.util.send(await EmbedUtil_1.BuildEmbed(this.client, `**Minecraft Genie**`, `*You are not able to run commands in DMs, you must be in a server!*`, [])).then(msg => {
                msg.delete({ timeout: 30000 });
            });
        let args = message.toString().split(" ").filter((value, index) => index !== 0);
        if (args.length < 1) {
            return await message.util.send(await EmbedUtil_1.BuildEmbed(this.client, "**Minecraft Genie**", "*You must provide a Username or UUID!*", [
                { name: `Usage`, value: `${this.description["usage"]}` },
                { name: `Examples`, value: `${this.description["examples"].join("\n")}` }
            ])).then(msg => {
                msg.delete({ timeout: 60000 });
            });
        }
        if (args.length > 1) {
            return await message.util.send(await EmbedUtil_1.BuildEmbed(this.client, "**Minecraft Genie**", "*You must provide only one argument!*", [
                { name: `Usage`, value: `${this.description["usage"]}` },
                { name: `Examples`, value: `${this.description["examples"].join("\n")}` }
            ])).then(msg => {
                msg.delete({ timeout: 60000 });
            });
        }
        const minecraftResponse = await minecraft_player_1.default(args[0]).catch(async (error) => {
            return await message.util.send(await EmbedUtil_1.BuildEmbed(this.client, "**Minecraft Genie**", `*You must provide a valid identifier!*\n**INVALID IDENTIFIER:** \`${args[0]}\``, [
                { name: `Usage`, value: `${this.description["usage"]}` },
                { name: `Examples`, value: `${this.description["examples"].join("\n")}` }
            ])).then(msg => {
                msg.delete({ timeout: 60000 });
            });
        });
        if (!minecraftResponse)
            return;
        return await message.util.send(await EmbedUtil_1.BuildEmbed(this.client, `**Minecraft Genie**`, `*Stay patient while we retrieve the skin of: \`${minecraftResponse["username"]}\`!*`, [])).then(async (msg) => {
            var download = (uri, filename, callback) => {
                request_1.default.head(uri, (err) => {
                    if (err)
                        return;
                    request_1.default(uri).pipe(fs_1.default.createWriteStream(filename)).on('close', callback);
                });
            };
            download(`https://visage.surgeplay.com/full/832/${minecraftResponse["uuid"]}`, `${__dirname}/../../skins/${minecraftResponse["uuid"]}.png`, async () => {
                let imageAttachment = `${__dirname}/../../skins/${minecraftResponse["uuid"]}.png`;
                await msg.delete();
                return await message.util.send(await EmbedUtil_1.BuildEmbed(this.client, "**Minecraft Genie**", `*You are viewing the skin of: \`${minecraftResponse["username"]}\`*`, [], [imageAttachment])).then(async (msg) => {
                    await msg.delete({ timeout: 60000 });
                });
            });
        });
    }
}
exports.default = ModelCommand;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW9kZWxDb21tYW5kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1hbmRzL1B1YmxpYyBDb21tYW5kcy9Nb2RlbENvbW1hbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxtREFBeUM7QUFDekMseUNBQXNDO0FBRXRDLHFEQUFtRDtBQUNuRCx3RUFBeUM7QUFDekMsNENBQW9CO0FBQ3BCLHNEQUE4QjtBQUU5QixNQUFxQixZQUFhLFNBQVEsd0JBQU87SUFDN0M7UUFDSSxLQUFLLENBQUMsT0FBTyxFQUFFO1lBQ1gsT0FBTyxFQUFFLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sQ0FBQztZQUN0RCxRQUFRLEVBQUUsaUJBQWlCO1lBQzNCLFdBQVcsRUFBRTtnQkFDVCxPQUFPLEVBQUUsMERBQTBEO2dCQUNuRSxLQUFLLEVBQUUsR0FBRyxlQUFNLHVCQUF1QjtnQkFDdkMsUUFBUSxFQUFFO29CQUNOLEdBQUcsZUFBTSxnQkFBZ0I7b0JBQ3pCLEdBQUcsZUFBTSw0Q0FBNEM7aUJBQ3hEO2FBQ0o7WUFDRCxTQUFTLEVBQUUsQ0FBQztTQUNmLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTSxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQWdCLEVBQUUsRUFBRSxVQUFVLEVBQTBCO1FBQ3RFLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLElBQUksSUFBSTtZQUFFLE9BQU8sTUFBTSxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLHNCQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxxQkFBcUIsRUFBRSxxRUFBcUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDek0sR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFBO1lBQ2xDLENBQUMsQ0FBQyxD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QUFDLENBQUM7Z0JBQ3pDLENBQUMsQ0FBQyxDQUFBO1lBQ04sQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUM7Q0FDSjtBQXRFRCwrQkFzRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21tYW5kIH0gZnJvbSBcImRpc2NvcmQtYWthaXJvXCI7XHJcbmltcG9ydCB7IHByZWZpeCB9IGZyb20gXCIuLi8uLi9jb25maWdcIjtcclxuaW1wb3J0IHsgTWVzc2FnZSB9IGZyb20gXCJkaXNjb3JkLmpzXCI7XHJcbmltcG9ydCB7IEJ1aWxkRW1iZWQgfSBmcm9tIFwiLi4vLi4vdXRpbHMvRW1iZWRVdGlsXCI7XHJcbmltcG9ydCBNaW5lY3JhZnQgZnJvbSBcIm1pbmVjcmFmdC1wbGF5ZXJcIjtcclxuaW1wb3J0IGZzIGZyb20gXCJmc1wiO1xyXG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0JztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1vZGVsQ29tbWFuZCBleHRlbmRzIENvbW1hbmQge1xyXG4gICAgcHVibGljIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHN1cGVyKFwibW9kZWxcIiwge1xyXG4gICAgICAgICAgICBhbGlhc2VzOiBbXCJtb2RlbFwiLCBcInNraW5cIiwgXCJwbGF5ZXJcIiwgXCJyZW5kZXJcIiwgXCJ2aWV3XCJdLFxyXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJQdWJsaWMgQ29tbWFuZHNcIixcclxuICAgICAgICAgICAgZGVzY3JpcHRpb246IHtcclxuICAgICAgICAgICAgICAgIGNvbnRlbnQ6IFwiVmlldyB0aGUgcmVuZGVyZWQgc2tpbiBvZiBhIHJlZ2lzdGVyZWQgTWluZWNyYWZ0IG1lbWJlci5cIixcclxuICAgICAgICAgICAgICAgIHVzYWdlOiBgJHtwcmVmaXh9bW9kZWwgW3VzZXJuYW1lL3V1aWRdYCxcclxuICAgICAgICAgICAgICAgIGV4YW1wbGVzOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgYCR7cHJlZml4fW1vZGVsIFJlaGVpZ2h0YCxcclxuICAgICAgICAgICAgICAgICAgICBgJHtwcmVmaXh9bW9kZWwgZDRiZTA3YWItZmM4MC00NmNhLTg3MDYtNzA5NDdhOGU5YmViYFxyXG4gICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByYXRlbGltaXQ6IDNcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgZXhlYyhtZXNzYWdlOiBNZXNzYWdlLCB7IGlkZW50aWZpZXIgfTogeyBpZGVudGlmaWVyOiBzdHJpbmcgfSk6IFByb21pc2U8YW55PiB7XHJcbiAgICAgICAgaWYgKG1lc3NhZ2UuY2hhbm5lbC50eXBlID09IFwiZG1cIikgcmV0dXJuIGF3YWl0IG1lc3NhZ2UudXRpbC5zZW5kKGF3YWl0IEJ1aWxkRW1iZWQodGhpcy5jbGllbnQsIGAqKk1pbmVjcmFmdCBHZW5pZSoqYCwgYCpZb3UgYXJlIG5vdCBhYmxlIHRvIHJ1biBjb21tYW5kcyBpbiBETXMsIHlvdSBtdXN0IGJlIGluIGEgc2VydmVyISpgLCBbXSkpLnRoZW4obXNnID0+IHtcclxuICAgICAgICAgICAgbXNnLmRlbGV0ZSh7IHRpbWVvdXQ6IDMwMDAwIH0pXHJcbiAgICAgICAgfSlcclxuICAgICAgICBcclxuICAgICAgICBsZXQgYXJnczogc3RyaW5nW10gPSBtZXNzYWdlLnRvU3RyaW5nKCkuc3BsaXQoXCIgXCIpLmZpbHRlcigodmFsdWU6IHN0cmluZywgaW5kZXg6IG51bWJlcikgPT4gaW5kZXggIT09IDApO1xyXG5cclxuICAgICAgICBpZiAoYXJncy5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBtZXNzYWdlLnV0aWwuc2VuZChhd2FpdCBCdWlsZEVtYmVkKHRoaXMuY2xpZW50LCBcIioqTWluZWNyYWZ0IEdlbmllKipcIiwgXCIqWW91IG11c3QgcHJvdmlkZSBhIFVzZXJuYW1lIG9yIFVVSUQhKlwiLCBbXHJcbiAgICAgICAgICAgICAgICB7IG5hbWU6IGBVc2FnZWAsIHZhbHVlOiBgJHt0aGlzLmRlc2NyaXB0aW9uW1widXNhZ2VcIl19YCB9LFxyXG4gICAgICAgICAgICAgICAgeyBuYW1lOiBgRXhhbXBsZXNgLCB2YWx1ZTogYCR7dGhpcy5kZXNjcmlwdGlvbltcImV4YW1wbGVzXCJdLmpvaW4oXCJcXG5cIil9YCB9XHJcbiAgICAgICAgICAgIF0pKS50aGVuKG1zZyA9PiB7XHJcbiAgICAgICAgICAgICAgICBtc2cuZGVsZXRlKHsgdGltZW91dDogNjAwMDAgfSlcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoYXJncy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBtZXNzYWdlLnV0aWwuc2VuZChhd2FpdCBCdWlsZEVtYmVkKHRoaXMuY2xpZW50LCBcIioqTWluZWNyYWZ0IEdlbmllKipcIiwgXCIqWW91IG11c3QgcHJvdmlkZSBvbmx5IG9uZSBhcmd1bWVudCEqXCIsIFtcclxuICAgICAgICAgICAgICAgIHsgbmFtZTogYFVzYWdlYCwgdmFsdWU6IGAke3RoaXMuZGVzY3JpcHRpb25bXCJ1c2FnZVwiXX1gIH0sXHJcbiAgICAgICAgICAgICAgICB7IG5hbWU6IGBFeGFtcGxlc2AsIHZhbHVlOiBgJHt0aGlzLmRlc2NyaXB0aW9uW1wiZXhhbXBsZXNcIl0uam9pbihcIlxcblwiKX1gIH1cclxuICAgICAgICAgICAgXSkpLnRoZW4obXNnID0+IHtcclxuICAgICAgICAgICAgICAgIG1zZy5kZWxldGUoeyB0aW1lb3V0OiA2MDAwMCB9KVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgbWluZWNyYWZ0UmVzcG9uc2U6IGFueSA9IGF3YWl0IE1pbmVjcmFmdChhcmdzWzBdKS5jYXRjaChhc3luYyAoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IG1lc3NhZ2UudXRpbC5zZW5kKGF3YWl0IEJ1aWxkRW1iZWQodGhpcy5jbGllbnQsIFwiKipNaW5lY3JhZnQgR2VuaWUqKlwiLCBgKllvdSBtdXN0IHByb3ZpZGUgYSB2YWxpZCBpZGVudGlmaWVyISpcXG4qKklOVkFMSUQgSURFTlRJRklFUjoqKiBcXGAke2FyZ3NbMF19XFxgYCwgW1xyXG4gICAgICAgICAgICAgICAgeyBuYW1lOiBgVXNhZ2VgLCB2YWx1ZTogYCR7dGhpcy5kZXNjcmlwdGlvbltcInVzYWdlXCJdfWAgfSxcclxuICAgICAgICAgICAgICAgIHsgbmFtZTogYEV4YW1wbGVzYCwgdmFsdWU6IGAke3RoaXMuZGVzY3JpcHRpb25bXCJleGFtcGxlc1wiXS5qb2luKFwiXFxuXCIpfWAgfVxyXG4gICAgICAgICAgICBdKSkudGhlbihtc2cgPT4ge1xyXG4gICAgICAgICAgICAgICAgbXNnLmRlbGV0ZSh7IHRpbWVvdXQ6IDYwMDAwIH0pXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIGlmICghbWluZWNyYWZ0UmVzcG9uc2UpIHJldHVybjtcclxuICAgICAgICBcclxuICAgICAgICByZXR1cm4gYXdhaXQgbWVzc2FnZS51dGlsLnNlbmQoYXdhaXQgQnVpbGRFbWJlZCh0aGlzLmNsaWVudCwgYCoqTWluZWNyYWZ0IEdlbmllKipgLCBgKlN0YXkgcGF0aWVudCB3aGlsZSB3ZSByZXRyaWV2ZSB0aGUgc2tpbiBvZjogXFxgJHttaW5lY3JhZnRSZXNwb25zZVtcInVzZXJuYW1lXCJdfVxcYCEqYCwgW10pKS50aGVuKGFzeW5jIChtc2cpID0+IHtcclxuICAgICAgICAgICAgdmFyIGRvd25sb2FkID0gKHVyaTogc3RyaW5nLCBmaWxlbmFtZTogc3RyaW5nLCBjYWxsYmFjazogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXF1ZXN0LmhlYWQodXJpLCAoZXJyOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdCh1cmkpLnBpcGUoZnMuY3JlYXRlV3JpdGVTdHJlYW0oZmlsZW5hbWUpKS5vbignY2xvc2UnLCBjYWxsYmFjayk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9XHJcbiAgICBcclxuICAgICAgICAgICAgZG93bmxvYWQoYGh0dHBzOi8vdmlzYWdlLnN1cmdlcGxheS5jb20vZnVsbC84MzIvJHttaW5lY3JhZnRSZXNwb25zZVtcInV1aWRcIl19YCwgYCR7X19kaXJuYW1lfS8uLi8uLi9za2lucy8ke21pbmVjcmFmdFJlc3BvbnNlW1widXVpZFwiXX0ucG5nYCwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IGltYWdlQXR0YWNobWVudCA9IGAke19fZGlybmFtZX0vLi4vLi4vc2tpbnMvJHttaW5lY3JhZnRSZXNwb25zZVtcInV1aWRcIl19LnBuZ2A7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCBtc2cuZGVsZXRlKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgbWVzc2FnZS51dGlsLnNlbmQoYXdhaXQgQnVpbGRFbWJlZCh0aGlzLmNsaWVudCwgXCIqKk1pbmVjcmFmdCBHZW5pZSoqXCIsIGAqWW91IGFyZSB2aWV3aW5nIHRoZSBza2luIG9mOiBcXGAke21pbmVjcmFmdFJlc3BvbnNlW1widXNlcm5hbWVcIl19XFxgKmAsIFtdLCBbaW1hZ2VBdHRhY2htZW50XSkpLnRoZW4oYXN5bmMgbXNnID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBtc2cuZGVsZXRlKHsgdGltZW91dDogNjAwMDAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG59XHJcbiJdfQ==